# NoSQL Injection
----
**NoSQL** or **"Not Only SQL"**, is a **non-relational**, modern database.
It doesnt store data in the form of tables (rows and columns) unlike traditional databases; Hence it is schema-less db.
Popular NoSQL DB includes :-
 - Document-Based → MongoDB, CouchDB (Store JSON-like documents)
 - Key-Value Stores → Redis, DynamoDB (Use key-value pairs)
 - Column-Family Stores → Cassandra, HBase (Optimized for large-scale data storage)
 - Graph-Based → Neo4j (Stores relationships between entities)

## **What is NoSQL injection?**

**NoSQL injection** is a vulnerability where an attacker is able to interfere with the queries that an application makes to a NoSQL database. NoSQL injection may enable an attacker to:
 - Bypass authentication or protection mechanisms.
   - Many NoSQL databases are configured with default or no authentication.
   - Lack of role-based access control (RBAC) can expose sensitive data.
 - Extract or edit data.
 - Cause a denial of service.
   - Attackers can craft queries that consume excessive memory or CPU, causing service disruptions.
   - Example: Passing large payloads in MongoDB $where queries can lead to performance issues.
 - Execute code on the server.

### **EXAMPLE :**
```
db.users.find({ username: userInput }); // If userInput is `{ "$ne": null }`, it bypasses auth!
```
----
There are **two** types of **NoSQL injection attacks**:

**Syntax Injection** → Breaking the NoSQL query syntax and injecting custom payloads.

**Operator Injection** → Using NoSQL operators ($ne, $gt, $regex, etc.) to manipulate queries.

----
### **Why API Knowledge Matters?**

 - **MongoDB** → Uses {} for queries → Inject { "$ne": null }.
 - **CouchDB/Firebase** → Uses JSON over REST → Inject {"$gt": ""}.
 - **Redis** → Uses commands → Inject FLUSHALL to erase data.
 - **Cassandra** → Uses SQL-like CQL → Try ALLOW FILTERING for bypassing.

----
----
## **NoSQL syntax injection**

You can potentially detect **NoSQL injection vulnerabilities** by attempting to **break the query syntax**. To do this, systematically test each **input** by submitting **fuzz strings** and **special characters** that trigger a database error or some other detectable behavior if they're not adequately sanitized or filtered by the application.

**EXAMPLE :**
````
{
  "username": "",
  "password": { "$ne": null }
}
````
----
## NoSQL operator injection

**NoSQL databases** often use query operators, which provide ways to specify conditions that data must meet to be included in the query result. 
Examples of MongoDB query operators include:
 - $where - Matches documents that satisfy a JavaScript expression.
 - $ne - Matches all values that are not equal to a specified value.
 - $in - Matches all of the values specified in an array.
 - $regex - Selects documents where values match a specified regular expression.
You may be able to inject query operators to manipulate NoSQL queries. To do this, systematically submit different operators into a range of user inputs, then review the responses for error messages or other changes.
----
## Timing based injection

Sometimes triggering a database error doesn't cause a difference in the application's response. In this situation, you may still be able to detect and exploit the vulnerability by using JavaScript injection to trigger a conditional time delay.

To conduct timing-based NoSQL injection:
 - Load the page several times to determine a baseline loading time.
 - Insert a timing based payload into the input. A timing based payload causes an intentional delay in the response when executed. For example, {"$where":"sleep(5000)"} causes an intentional delay of 5000 ms on successful injection.
 - Identify whether the response loads more slowly. This indicates a successful injection.

The following timing based payloads will trigger a time delay if the password beings with the letter a:
````
admin'+function(x){var waitTill = new Date(new Date().getTime() + 5000);while((x.password[0]==="a") && waitTill > new Date()){};}(this)+'

admin'+function(x){if(x.password[0]==="a"){sleep(5000)};}(this)+'
````
## Preventing NoSQL injection
The appropriate way to prevent NoSQL injection attacks depends on the specific NoSQL technology in use. As such, we recommend reading the security documentation for your NoSQL database of choice. That said, the following broad guidelines will also help:
 - Sanitize and validate user input, using an allowlist of accepted characters.
 - Insert user input using parameterized queries instead of concatenating user input directly into the query.
 - To prevent operator injection, apply an allowlist of accepted keys.
