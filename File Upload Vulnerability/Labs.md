**Lab: Remote code execution via web shell upload**

**Aim** - To solve the lab, upload a basic PHP web shell and use it to exfiltrate the contents of the file /home/carlos/secret

Your credentials - **wiener:peter**

**1. Logging In and Observing the Avatar Upload Functionality**

While proxying traffic through Burp Suite, I logged into my account on the target website.

On the account page, I noticed an option to upload an avatar image.

I uploaded a random image (e.g., test.jpg) and observed that a preview of the avatar appeared on my account page.

**2. Identifying the Avatar Fetch Request**

In Burp Suite, I navigated to Proxy > HTTP history to examine the traffic.

I used the filter bar to filter requests by MIME type:

Opened the filter window.

Enabled the Images checkbox.

Applied the changes.

In the filtered HTTP history, I found a GET request that fetched the uploaded avatar using this pattern:

GET /files/avatars/<YOUR-IMAGE>

I sent this request to Burp Repeater for further testing.

**3. Preparing the Exploit File**

On my local system, I created a file named exploit.php containing the following malicious PHP script:

<?php echo file_get_contents('/home/carlos/secret'); ?>

This script attempts to read the contents of Carlos's secret file located at /home/carlos/secret.

**4. Uploading the Malicious PHP File**

I returned to the avatar upload functionality on the website and uploaded my exploit.php file as the avatar.

The server responded with a confirmation message indicating that the file was successfully uploaded.

**5. Executing the Exploit**

In Burp Repeater, I modified the path in the previously captured GET request to point to my malicious PHP file:

GET /files/avatars/exploit.php HTTP/1.1

I sent the request. The server executed the PHP script and returned its output, which contained Carlos's secret.

**6. Submitting the Secret**

I copied Carlos's secret from the response and submitted it to complete the lab.

**Key Observations**

The server did not properly validate the file type during the upload, allowing me to upload a PHP file.

When the uploaded PHP file was accessed, the server executed it instead of treating it as a regular file.

This vulnerability is an example of Unrestricted File Upload, which can lead to Remote Code Execution (RCE) if exploited.

**Lab: Web shell upload via Content-Type restriction bypass**

**Step 1: Analyze the Avatar Upload Functionality**

Log in to your account on the target application.

Navigate to the avatar upload feature and upload an arbitrary image (e.g., image.jpg) as your avatar.

After uploading, return to your account page. Notice that the uploaded image is displayed as a preview.

**Step 2: Intercept the Image Fetch Request**

Open Burp Suite and go to Proxy > HTTP history.

Locate the GET request used to fetch your avatar image at the path /files/avatars/<YOUR-IMAGE>.

Send this request to Burp Repeater for later use.

**Step 3: Create the Exploit Script**

On your local machine, create a PHP script named exploit.php with the following contents:

**<?php echo file_get_contents('/home/carlos/secret'); ?>**

This script reads the sensitive file /home/carlos/secret and outputs its contents.

**Step 4: Attempt to Upload the Exploit Script**

Use the avatar upload functionality to attempt uploading exploit.php as your avatar.

Observe that the server rejects the upload, stating that only files with the MIME type image/jpeg or image/png are allowed.

**Step 5: Modify the File Upload Request**

Go to Proxy > HTTP history in Burp Suite.

Find the POST /my-account/avatar request responsible for submitting the avatar upload.

Send this request to Burp Repeater.

In Burp Repeater, locate the section in the request body that specifies the Content-Type for the uploaded file. Change it from:

Content-Type: application/x-php
to:
Content-Type: image/jpeg

Send the modified request.

Observe that the server responds, confirming the file upload was successful.

**Step 6: Execute the Malicious Script**

Switch to the GET /files/avatars/<YOUR-IMAGE> request in Burp Repeater.

Replace the file name in the path with exploit.php:

GET /files/avatars/exploit.php HTTP/1.1

Send the request.

Observe that the server executes the script and returns the contents of Carlos's secret file in the response.

**Step 7: Submit the Secret**

Copy the secret returned in the response.

Submit it to the lab to complete the challenge.

Key Takeaways

Weak File Validation: The server only checks the Content-Type header for file validation, which can easily be manipulated.

Insecure File Uploads: Allowing execution of uploaded files without proper validation leads to vulnerabilities like Remote Code Execution (RCE).

Best Practices:

Validate uploaded files based on their actual content (e.g., checking file headers or magic bytes).

Store uploaded files in non-executable directories to prevent them from being executed on the server.

**Lab: Web shell upload via path traversal**

**Step 1: Analyze the Avatar Upload Functionality**

Log in to your account on the target application.

Navigate to the avatar upload feature and upload an arbitrary image (e.g., image.jpg) as your avatar.

After uploading, return to your account page. Notice that the uploaded image is displayed as a preview.

**Step 2: Intercept the Image Fetch Request**

Open Burp Suite and go to Proxy > HTTP history.

Locate the GET request used to fetch your avatar image at the path /files/avatars/<YOUR-IMAGE>.

Send this request to Burp Repeater for later use.

**Step 3: Create the Exploit Script**

On your local machine, create a PHP script named exploit.php with the following contents:

**<?php echo file_get_contents('/home/carlos/secret'); ?>**

This script reads the sensitive file /home/carlos/secret and outputs its contents.

**Step 4: Attempt to Upload the Exploit Script**

Use the avatar upload functionality to attempt uploading exploit.php as your avatar.

Observe that the server rejects the upload, stating that only files with the MIME type image/jpeg or image/png are allowed.

**Step 5: Modify the File Upload Request**

Go to Proxy > HTTP history in Burp Suite.

Find the POST /my-account/avatar request responsible for submitting the avatar upload.

Send this request to Burp Repeater.

In Burp Repeater, locate the section in the request body that specifies the Content-Type for the uploaded file. Change it from:

Content-Type: application/x-php
**to:**
Content-Type: image/jpeg

Send the modified request.

Observe that the server responds, confirming the file upload was successful.

**Step 6: Execute the Malicious Script**

Switch to the GET /files/avatars/<YOUR-IMAGE> request in Burp Repeater.

Replace the file name in the path with exploit.php:

GET /files/avatars/exploit.php HTTP/1.1

Send the request.

Observe that the server executes the script and returns the contents of Carlos's secret file in the response.

**Step 7: Submit the Secret**

Copy the secret returned in the response.

Submit it to the lab to complete the challenge.
"**Btb8vzFNtwLrmvb1FFAe7uybK8EVS2T***"

**Key Takeaways**

Weak File Validation: The server only checks the Content-Type header for file validation, which can easily be manipulated.

Insecure File Uploads: Allowing execution of uploaded files without proper validation leads to vulnerabilities like Remote Code Execution (RCE).

Best Practices:

Validate uploaded files based on their actual content (e.g., checking file headers or magic bytes).

Store uploaded files in non-executable directories to prevent them from being executed on the server.
