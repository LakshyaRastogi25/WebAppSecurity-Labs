# **Write-Up: 1 Limit overrun race conditions**

#### **Objective:**
The goal of this lab is to exploit a **race condition** in the shopping cart mechanism to apply a discount code multiple times, reducing the total cost of an item beyond the intended limit.

---

## **Step 1: Understanding the Shopping Cart Mechanism**
1. **Log in** to your account and buy the **cheapest** item available.
2. Apply the provided **discount code** and observe how the purchasing process works.
3. In **Burp Suite**, analyze the HTTP requests related to shopping cart operations.  
   - **Key Endpoints:**
     - `POST /cart` → Adds an item to the cart.
     - `POST /cart/coupon` → Applies a discount code.
     - `GET /cart` → Fetches cart details.
4. Identify any restrictions in place, such as:
   - **A coupon can only be applied once** (receives a `"Coupon already applied"` response).
   - The **shopping cart state is stored server-side** and is linked to the session ID.

---

## **Step 2: Identifying a Race Condition**
### **Confirming Session-Based Cart Storage**
- **Send a `GET /cart` request** in Burp **with and without your session cookie**:
  - **With the session cookie** → Shows your cart.
  - **Without the session cookie** → Shows an empty cart.
- **Inference:** The cart is **stored server-side**, and operations on it are **keyed on your session ID**.

### **Finding a Race Window**
- When a discount code is applied (`POST /cart/coupon`), the database updates the cart **to prevent reusing the same code**.
- If multiple requests are sent **simultaneously**, there may be a **short time window** where the system hasn’t fully updated the database, allowing the discount to be applied multiple times.

---

## **Step 3: Benchmarking the Behavior**
1. **Ensure no discount code is applied** to your cart.
2. **Send a `POST /cart/coupon` request in Burp Repeater**.
3. **Create a new group tab** for this request.
4. **Duplicate the request 19 times** (total 20 requests).
5. **Send the requests sequentially** (one after another).
6. Observe the responses:
   - The **first** request successfully applies the discount.
   - The **remaining** requests fail with `"Coupon already applied"`.
![Screenshot from 2025-01-21 19-52-51](https://github.com/user-attachments/assets/be0104e6-e5d4-46af-ae8e-4262f2449363)

---

## **Step 4: Exploiting the Race Condition**
1. **Remove the discount code from your cart**.
2. **Send the group of requests in parallel**:
   - This will send all 20 discount application requests **at the same time**, increasing the chances of bypassing the restriction.
3. **Analyze the responses**:
   - If multiple responses return `"Coupon successfully applied"`, the attack worked.
4. **Refresh your cart** in the browser.
   - If successful, the **discount has been applied multiple times**, reducing the item price significantly.
![Screenshot from 2025-01-21 19-52-36](https://github.com/user-attachments/assets/216a5431-015f-493e-a2d7-ed476070c65d)

---

## **Step 5: Proving the Concept**
1. **Remove the applied codes and the cheap item** from your cart.
2. **Add an expensive item** (e.g., a leather jacket) to your cart.
3. **Resend the batch of `POST /cart/coupon` requests in parallel**.
4. **Refresh the cart and check the order total**:
   - If the total is still **higher** than your store credit, remove the codes and repeat the attack.
   - If the total is **lower** than your store credit, proceed with the purchase.
5. **Buy the jacket and solve the lab!**
![Screenshot from 2025-01-21 19-52-45](https://github.com/user-attachments/assets/1e467792-8dba-438a-bbe5-17faf4ece4d4)

---
# **Write-Up: 2 Exploiting Race Conditions to Bypass Login Rate Limits**

### **Objective**
The goal of this lab is to exploit a **race condition in login rate limiting** to brute-force the password of the **admin user (carlos)** before the system locks the account.

---

## **Step 1: Understanding the Login Rate Limit Mechanism**
1. **Submit incorrect passwords for your own account.**
   - Observe that after **three incorrect attempts**, your account is **temporarily locked** from further login attempts.
   
2. **Try logging in with a random username** (not your own).
   - Notice that you receive a **normal "Invalid username or password"** message.
   - This confirms that the rate limit **is enforced per username, not per session**.

3. **Inference:**
   - The system **stores failed login attempts server-side**.
   - There is a small **race window** between:
     - When a login attempt is made.
     - When the system increments the failed login counter.

---

## **Step 2: Benchmarking the Behavior**
1. **Find an unsuccessful login request** in Burp's Proxy history (`POST /login`).
2. **Send this request to Burp Repeater**.
3. **Create a new tab group** and duplicate the request **19 times** (total 20 requests).
4. **Send the group of requests sequentially**.
   - The **first three attempts** will work normally.
   - After two more failures, the **account gets locked**.

---

## **Step 3: Exploiting the Race Condition**
1. **Remove any account locks** and ensure fresh login attempts.
2. **Send the group of requests again, but this time in parallel.**
3. **Analyze the responses:**
   - Even though the account should be locked, **more than three login attempts** receive `"Invalid username and password"` instead of `"Account locked"`.
   - This means the system **hasn't updated the failed attempt counter fast enough**.
   - If we send multiple login attempts **simultaneously**, we can **bypass the limit** and guess more passwords before the account locks.

---

## **Step 4: Brute-Forcing Carlos' Password Using Turbo Intruder**
1. **Still in Burp Repeater**, highlight the **password** parameter in the `POST /login` request.
2. **Right-click** → **Extensions > Turbo Intruder > Send to Turbo Intruder**.
3. **Modify the request in Turbo Intruder:**
   - Change the `username` parameter to **carlos**.
   - Select the attack template **examples/race-single-packet-attack.py**.
   - Modify the script to queue requests using a **list of passwords**.
![Screenshot from 2025-01-23 21-36-24](https://github.com/user-attachments/assets/2558f471-2a4c-49d4-bb42-14d8fa06d1ab)

### **Turbo Intruder Attack Script:**
```python
def queueRequests(target, wordlists):
    engine = RequestEngine(endpoint=target.endpoint,
                           concurrentConnections=1,  # Use single-packet attack
                           engine=Engine.BURP2
                           )
    
    # Load passwords from clipboard
    passwords = wordlists.clipboard
    
    # Queue login requests for each password
    for password in passwords:
        engine.queue(target.req, password, gate='1')
    
    # Send all requests simultaneously
    engine.openGate('1')

def handleResponse(req, interesting):
    table.add(req)
```
![Screenshot from 2025-01-23 21-35-52](https://github.com/user-attachments/assets/36341d3a-9f85-4020-993f-94a134a890fe)

4. **Copy a list of candidate passwords** to your clipboard.
5. **Launch the attack**.

---

## **Step 5: Identifying the Correct Password**
1. **Check the responses in Turbo Intruder.**
   - If all attempts fail, **wait for the account lock to reset** and repeat.
   - Remove incorrect passwords from the list and retry.
2. **If a request returns a `302 Found` response**, this indicates a successful login.
   - The **corresponding password** in the "Payload" column is the correct password.
3. **Log in as carlos** using the identified password.
![Screenshot from 2025-01-23 21-35-29](https://github.com/user-attachments/assets/c43c9d1c-8f84-474e-92ec-8636a89db014)

---

## **Step 6: Deleting Carlos' Account**
1. **Access the admin panel.**
2. **Find the user "carlos"** in the admin interface.
3. **Delete the user** to complete the lab.
![Screenshot from 2025-01-23 21-35-16](https://github.com/user-attachments/assets/0eb24c8b-0e6f-4efb-b9f9-ab2333f2c2ca)

---

# Lab:3 Multi-endpoint race conditions

## Step 1: Login to the Account
 - Navigate to the login page.
 - Enter valid credentials and log in.
 - Confirm the available credit balance (e.g., 100 credits).
 
## Step 2: Analyze the Multi-Endpoint Workflow
 - The application processes the shopping flow through the following key endpoints:
 - /cart - To add items to the shopping cart.
 - /cart/checkout - To proceed with the checkout process.
 - Observing how the application processes purchases, we found that the credit validation occurs at the /cart/checkout endpoint.

## Step 3: Plan the Attack Strategy

**Goal: Purchase a leather jacket (costs more than 100 credits) by exploiting race conditions.**

Approach:
 - Add a low-cost item (e.g., a 10-credit gift card) to the cart.
 - Initiate the checkout process.
 - Add the expensive leather jacket to the cart.
 - Quickly send another checkout request for the gift card.

## Step 4: Execute the Race Condition Attack
 - Open Burp Suite and intercept the traffic.
 - Add a 10-credit gift card to the cart by capturing the request:
```
POST /cart
Body: {"item":"giftcard", "amount":10}
```
 - Send a checkout request for the gift card:
   POST /cart/checkout

**In Burp Suite, group the following three requests together:**
```
First: The initial gift card checkout request.

Second: Adding the expensive leather jacket to the cart.

Third: Another gift card checkout request.
```
![Screenshot from 2025-01-24 19-15-04](https://github.com/user-attachments/assets/f4341287-65da-4dd9-909b-215ec4e2b9e4)

## Set Burp Suite's attack mode to "Send group in single connection" to ensure the race condition is triggered.
 - Send the requests simultaneously.

## Step 5: Observe the Results
 - If successful, the application processes both checkout requests before the credit validation logic is applied to the jacket purchase. As a result, the leather jacket is purchased despite insufficient credits.
![Screenshot from 2025-01-24 19-14-07](https://github.com/user-attachments/assets/51fbf105-53cb-4909-bcd9-70a31819c109)


# Lab 4: Single-endpoint race conditions

### Objective:
Exploit a race condition vulnerability to change the email address of an admin account (carlos@ginandjuice.shop) and gain access to the admin panel.

**Steps to Perform the Attack:**

## Step 1: Initial Reconnaissance
 - Log in to the website using your credentials.
 - Navigate to the profile settings page.
 - Attempt to change your email to any valid email address you control.
 - Observe that you receive a confirmation link in your email inbox, which confirms the email change.

## Step 2: Configuring Burp Suite
 - Intercept the Email Change Request:
 - Open Burp Suite and enable "Intercept" in the Proxy tab.
 - Change your email to any valid email address.
 - Capture the HTTP POST request responsible for changing the email.
 - Send to Repeater for Analysis:
 - Forward the intercepted request to the Repeater tab.
 - Analyze the response to understand the flow of email confirmation.

## Prepare Attack Requests:
 - Go to the "HTTP history" tab and find the intercepted email change request.
 - Right-click and select "**Send to Intruder**."

## Step 3: Performing the Attack
 - Create a New Group Tab:
 - In Burp Suite, navigate to the "Repeater" tab.
 - Right-click the email change request and select "Send to new group tab."
 - Add the following sequence of requests to the group:
 - Your own email change request.
 - A request to change the email to **carlos@ginandjuice.shop**.
 - Your own email change request again.

## Perform Parallel Execution:
 - Send a normal GET request to the profile page.
 - Immediately send the group request in parallel by selecting "Send group in parallel" (single packet attack).

Monitor the Responses:
 - If successful, the email confirmation link for carlos@ginandjuice.shop will be sent to your email.

## Step 4: Access the Admin Panel
 - Check your inbox for the confirmation email for carlos@ginandjuice.shop.
 - Click the confirmation link.
 - You should now have access to the admin panel.

## Step 5: Deleting the Admin Account
 - Navigate to the admin panel.
 - Find the user "carlos".
 - Delete the user to complete the lab challenge.

## Conclusion:
By exploiting the race condition vulnerability, we successfully changed the admin email to an address under our control, allowing us to access the admin panel and delete the admin account. This highlights the importance of implementing proper synchronization mechanisms to prevent such attacks.

